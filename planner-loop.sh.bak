#!/bin/bash
# Planner agent continuous monitoring loop

PROJECT_PATH="$1"
SPEC_FILE="$2"
FEATURE_NAME="$3"
PLANNER_PROMPT="$4"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}ðŸŽ¯ PLANNER LOOP - Starting continuous monitoring${NC}"

# Phase 1: Initial spec analysis
if [ ! -f coordination/task_proposals.json ] || ! grep -q '"proposals"' coordination/task_proposals.json 2>/dev/null; then
    echo -e "${GREEN}Phase 1: Analyzing spec and creating proposals...${NC}"
    claude << EOF
$(cat $PLANNER_PROMPT)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SPEC FILE CONTENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$(cat $SPEC_FILE)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
START YOUR WORK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

You are now in the project directory: $PROJECT_PATH
The spec file is located at: $SPEC_FILE
Feature name: $FEATURE_NAME

IMPORTANT CONTEXT:
- The project is a Java project called StockMonitor
- Currently 108/183 tests are passing (59%)
- There are 75 tests remaining to fix
- You should work autonomously WITHOUT asking permission between fixes

Your coordination files are in:
- coordination/task_proposals.json (write your proposals here)
- coordination/active_work_registry.json (update your status here)
- coordination/logs/notifications.log (log your activities here)

PHASE 1: Analyze the spec above and create 2-3 implementation approaches
Write them to coordination/task_proposals.json with status: awaiting_review

Start by analyzing the spec and creating your proposals now.
EOF
fi

# Phase 2: Wait for approval
echo -e "${YELLOW}Phase 2: Waiting for reviewer approval...${NC}"
while true; do
    if [ -f coordination/task_proposals.json ] && grep -q '"approved"' coordination/task_proposals.json 2>/dev/null; then
        echo -e "${GREEN}Approval received! Starting implementation...${NC}"
        break
    fi
    echo "Still waiting for approval... (checking every 30s)"
    sleep 30
done

# Phase 3: Implementation
echo -e "${GREEN}Phase 3: Starting autonomous implementation...${NC}"
claude << EOF
$(cat $PLANNER_PROMPT)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
APPROVED PROPOSAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$(cat coordination/task_proposals.json)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SPEC FILE CONTENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$(cat $SPEC_FILE)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
IMPLEMENTATION PHASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

You are in project directory: $PROJECT_PATH
Feature: $FEATURE_NAME

The reviewer has APPROVED your proposal. Read the chosen_approach and 
implementation_instructions from the JSON above.

CRITICAL INSTRUCTIONS:
1. You are fixing the remaining 75 tests in StockMonitor
2. Currently 108/183 tests pass (59%)
3. Work AUTONOMOUSLY - do NOT ask for permission between fixes
4. Fix ALL tests until you reach 183/183 passing
5. Update coordination files with your progress
6. Log all activities to coordination/logs/notifications.log

Start implementing NOW according to the approved approach.
Continue fixing tests one by one until ALL 183 tests pass.
DO NOT STOP until complete.
EOF

echo -e "${GREEN}âœ… Implementation phase completed${NC}"
