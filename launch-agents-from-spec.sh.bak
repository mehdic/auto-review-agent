#!/bin/bash
set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}üöÄ Launching Autonomous Agent System from Spec File${NC}"
echo ""

# Check arguments
if [ -z "$1" ]; then
    echo -e "${RED}Usage: ./launch-agents-from-spec.sh /path/to/your/project [feature-number]${NC}"
    echo ""
    echo "Examples:"
    echo "  ./launch-agents-from-spec.sh /home/user/my-project          # Lists available specs"
    echo "  ./launch-agents-from-spec.sh /home/user/my-project 001     # Launches feature 001"
    echo "  ./launch-agents-from-spec.sh /home/user/my-project 007     # Launches latest feature 007"
    exit 1
fi

PROJECT_PATH="$1"
FEATURE_NUM="${2:-}"

# Check if project exists
if [ ! -d "$PROJECT_PATH" ]; then
    echo -e "${RED}‚ùå Project path does not exist: $PROJECT_PATH${NC}"
    exit 1
fi

# Check if specs directory exists
if [ ! -d "$PROJECT_PATH/specs" ]; then
    echo -e "${RED}‚ùå Specs directory not found: $PROJECT_PATH/specs${NC}"
    echo "Run: ./setup.sh $PROJECT_PATH"
    exit 1
fi

# Check if coordination directory exists
if [ ! -d "$PROJECT_PATH/coordination" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Coordination directory not found. Run setup.sh first!${NC}"
    echo "Run: ./setup.sh $PROJECT_PATH"
    exit 1
fi

# List available spec folders
SPEC_FOLDERS=$(find "$PROJECT_PATH/specs" -mindepth 1 -maxdepth 1 -type d -name "[0-9]*" | sort)

if [ -z "$SPEC_FOLDERS" ]; then
    echo -e "${RED}‚ùå No spec folders found in: $PROJECT_PATH/specs${NC}"
    echo "Create folders like: $PROJECT_PATH/specs/001-feature-name/"
    exit 1
fi

# If no feature number specified, list and ask
if [ -z "$FEATURE_NUM" ]; then
    echo -e "${YELLOW}üìÇ Available features:${NC}"
    echo ""
    for folder in $SPEC_FOLDERS; do
        folder_name=$(basename "$folder")
        spec_file="$folder/spec.md"
        if [ -f "$spec_file" ]; then
            feature_title=$(head -1 "$spec_file" | sed 's/# Feature Specification: //')
            echo "  ‚úì $folder_name - $feature_title"
        else
            echo "  ‚úó $folder_name - spec.md NOT FOUND"
        fi
    done
    echo ""
    echo "Usage: ./launch-agents-from-spec.sh $PROJECT_PATH [feature-number]"
    echo "Example: ./launch-agents-from-spec.sh $PROJECT_PATH 001"
    exit 0
fi

# Find the spec folder
SPEC_FOLDER="$PROJECT_PATH/specs/$FEATURE_NUM-"*
SPEC_FOLDER_FOUND=$(ls -d $SPEC_FOLDER 2>/dev/null | head -1)

if [ -z "$SPEC_FOLDER_FOUND" ]; then
    echo -e "${RED}‚ùå Feature folder not found starting with: $FEATURE_NUM-${NC}"
    echo -e "${YELLOW}Available features:${NC}"
    for folder in $SPEC_FOLDERS; do
        echo "  $(basename "$folder")"
    done
    exit 1
fi

SPEC_FILE="$SPEC_FOLDER_FOUND/spec.md"

if [ ! -f "$SPEC_FILE" ]; then
    echo -e "${RED}‚ùå spec.md not found in: $SPEC_FOLDER_FOUND${NC}"
    exit 1
fi

# Extract feature name from folder
FEATURE_NAME=$(basename "$SPEC_FOLDER_FOUND")

# Get absolute paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_PATH="$(cd "$PROJECT_PATH" && pwd)"
PLANNER_PROMPT="$SCRIPT_DIR/prompts/planner_agent_spec.txt"
REVIEWER_PROMPT="$SCRIPT_DIR/prompts/reviewer_agent_spec.txt"

echo -e "${BLUE}Configuration:${NC}"
echo "  Project: $PROJECT_PATH"
echo "  Feature: $FEATURE_NAME"
echo "  Spec File: $SPEC_FILE"
echo "  Planner prompt: $PLANNER_PROMPT"
echo "  Reviewer prompt: $REVIEWER_PROMPT"
echo ""

# Check if spec-based prompts exist, fallback to original prompts
if [ ! -f "$PLANNER_PROMPT" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Spec-based planner prompt not found, using standard planner${NC}"
    PLANNER_PROMPT="$SCRIPT_DIR/prompts/planner_agent.txt"
fi

if [ ! -f "$REVIEWER_PROMPT" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Spec-based reviewer prompt not found, using standard reviewer${NC}"
    REVIEWER_PROMPT="$SCRIPT_DIR/prompts/reviewer_agent.txt"
fi

# Check if prompts exist
if [ ! -f "$PLANNER_PROMPT" ]; then
    echo -e "${RED}‚ùå Planner prompt not found: $PLANNER_PROMPT${NC}"
    exit 1
fi

if [ ! -f "$REVIEWER_PROMPT" ]; then
    echo -e "${RED}‚ùå Reviewer prompt not found: $REVIEWER_PROMPT${NC}"
    exit 1
fi

# Check if tmux is installed
if ! command -v tmux &> /dev/null; then
    echo -e "${RED}‚ùå tmux is not installed. Please install it first:${NC}"
    echo "  Ubuntu/Debian: sudo apt install tmux"
    echo "  macOS: brew install tmux"
    exit 1
fi

# Check if Claude Code is installed
if ! command -v claude &> /dev/null; then
    echo -e "${RED}‚ùå Claude Code is not installed. Please install it first:${NC}"
    echo "  npm install -g claude"
    exit 1
fi

SESSION_NAME="agent_system_spec"

# Kill existing session if it exists
if tmux has-session -t $SESSION_NAME 2>/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Existing session found. Killing it...${NC}"
    tmux kill-session -t $SESSION_NAME
fi

echo -e "${GREEN}Creating tmux session: $SESSION_NAME${NC}"
echo ""

# Create tmux session with planner agent
tmux new-session -d -s $SESSION_NAME -n planner -c "$PROJECT_PATH"

# Set up planner pane title
tmux select-pane -t $SESSION_NAME:planner -T "üéØ PLANNER AGENT - $FEATURE_NAME"

# Create reviewer window
tmux new-window -t $SESSION_NAME -n reviewer -c "$PROJECT_PATH"
tmux select-pane -t $SESSION_NAME:reviewer -T "‚úÖ REVIEWER AGENT - $FEATURE_NAME"

# Create monitor window
tmux new-window -t $SESSION_NAME -n monitor -c "$PROJECT_PATH"

# Start planner agent
echo -e "${GREEN}Starting Planner Agent...${NC}"
# Make planner-loop.sh executable if it exists
if [ -f "$SCRIPT_DIR/planner-loop.sh" ]; then
    chmod +x "$SCRIPT_DIR/planner-loop.sh"
    tmux send-keys -t $SESSION_NAME:planner "cd $PROJECT_PATH && $SCRIPT_DIR/planner-loop.sh '$PROJECT_PATH' '$SPEC_FILE' '$FEATURE_NAME' '$PLANNER_PROMPT'" Enter
else
    # Fallback to direct invocation
    tmux send-keys -t $SESSION_NAME:planner "cd $PROJECT_PATH && claude << 'EOF'
$(cat $PLANNER_PROMPT)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SPEC FILE CONTENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$(cat $SPEC_FILE)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
START YOUR WORK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

You are now in the project directory: $PROJECT_PATH
The spec file is located at: $SPEC_FILE
Feature name: $FEATURE_NAME

IMPORTANT CONTEXT:
- The project is a Java project called StockMonitor
- Currently 108/183 tests are passing (59%)
- There are 75 tests remaining to fix
- You should work autonomously WITHOUT asking permission between fixes

Your coordination files are in:
- coordination/task_proposals.json (write your proposals here)
- coordination/active_work_registry.json (update your status here)
- coordination/logs/notifications.log (log your activities here)

PHASE 1: Analyze the spec above and create 2-3 implementation approaches
PHASE 2: Write them to coordination/task_proposals.json with status: awaiting_review
PHASE 3: Monitor for approval, then implement autonomously

Start by analyzing the spec and creating your proposals now.
EOF" Enter
fi

# Wait a moment
sleep 1

# Start reviewer agent
echo -e "${GREEN}Starting Reviewer Agent...${NC}"
tmux send-keys -t $SESSION_NAME:reviewer "cd $PROJECT_PATH && while true; do
  # Check if there are proposals awaiting review
  if [ -f coordination/task_proposals.json ] && grep -q '\"awaiting_review\"' coordination/task_proposals.json 2>/dev/null; then
    echo -e '${BLUE}‚úÖ REVIEWER: Found proposals to review!${NC}'
    claude << 'EOF'
$(cat $REVIEWER_PROMPT)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CURRENT PROPOSALS TO REVIEW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$(cat coordination/task_proposals.json 2>/dev/null || echo '{}')

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SPEC FILE CONTENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$(cat $SPEC_FILE)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
YOUR TASK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

You are in project directory: $PROJECT_PATH
Feature: $FEATURE_NAME

The planner has submitted proposals for review. You need to:
1. Evaluate each proposal against the spec
2. Choose the best approach
3. Update coordination/task_proposals.json with status: approved
4. Add your chosen_approach, reviewer_notes, and implementation_instructions

After approving, the planner will implement autonomously.
Remember: This is for fixing 75 remaining tests in StockMonitor (108/183 passing).

Start your review and approval process now.
EOF
    # After review, wait before checking again
    sleep 60
  else
    echo -e '${YELLOW}Waiting for proposals... (checking every 30s)${NC}'
    sleep 30
  fi
done" Enter

# Wait a moment
sleep 1

# Start monitor
tmux send-keys -t $SESSION_NAME:monitor "cd $PROJECT_PATH && echo -e '${BLUE}üìä MONITOR - Task System Status${NC}' && echo '' && while true; do
  clear
  echo -e '${BLUE}üìä MONITOR - Task System Status${NC}'
  echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
  echo ''
  echo '=== Active Work ==='
  if [ -f coordination/active_work_registry.json ]; then
    cat coordination/active_work_registry.json | python3 -m json.tool 2>/dev/null || cat coordination/active_work_registry.json
  else
    echo '{\"agents\": {}}'
  fi
  echo ''
  echo '=== Task Proposals Status ==='
  if [ -f coordination/task_proposals.json ]; then
    cat coordination/task_proposals.json | python3 -m json.tool | head -20 2>/dev/null || cat coordination/task_proposals.json | head -20
  else
    echo '{\"proposals\": [], \"status\": \"idle\"}'
  fi
  echo ''
  echo '=== Recent Logs ==='
  if [ -f coordination/logs/notifications.log ]; then
    tail -n 10 coordination/logs/notifications.log
  else
    echo 'No logs yet...'
  fi
  echo ''
  echo 'Press Ctrl+C to stop monitoring'
  sleep 2
done" Enter

# Display the session
echo -e "${GREEN}‚úÖ Session started: $SESSION_NAME${NC}"
echo ""
echo -e "${BLUE}üìä Tmux Layout:${NC}"
echo "  Window 1 (planner): üéØ PLANNER AGENT"
echo "  Window 2 (reviewer): ‚úÖ REVIEWER AGENT"
echo "  Window 3 (monitor): üìä MONITOR"
echo ""
echo -e "${YELLOW}üí° Controls:${NC}"
echo "  Ctrl+b 0  ‚Üí Planner window"
echo "  Ctrl+b 1  ‚Üí Reviewer window"
echo "  Ctrl+b 2  ‚Üí Monitor window"
echo "  Ctrl+b d  ‚Üí Detach from session"
echo "  Ctrl+b x  ‚Üí Kill pane"
echo ""
echo -e "${BLUE}üìù Feature Details:${NC}"
echo "  Feature: $FEATURE_NAME"
echo "  Spec File: $SPEC_FILE"
echo ""

# Attach to the session
tmux attach-session -t $SESSION_NAME
